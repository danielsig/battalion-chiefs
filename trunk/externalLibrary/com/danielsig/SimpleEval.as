package com.danielsig{	import flash.geom.Point;	import flash.utils.*;		public class SimpleEval	{		private var _code : Array;		private var _args : Array;		private var _local : Boolean = false;				private function traceLocals() : void		{			var codeString : Array = _code.concat();			for(var c : int = 0; c < codeString.length; c++)			{				if(codeString[c] is Function)				{					var f : Function = codeString[c];					if(f == Divide)						codeString[c] = "/";					else if(f == Multiply)						codeString[c] = "*";					else if(f == Plus)						codeString[c] = "+";					else if(f == Minus)						codeString[c] = "-";					else if(f == LessThan)						codeString[c] = "<";					else if(f == GreaterThan)						codeString[c] = ">";					else if(f == LessThanOrEquals)						codeString[c] = "<=";					else if(f == GreaterThanOrEquals)						codeString[c] = ">=";					else if(f == Equals)						codeString[c] = "==";					else if(f == NotEquals)						codeString[c] = "!=";					else if(f == And)						codeString[c] = "&&";					else if(f == Or)						codeString[c] = "||";					else if(f == IfElse)						codeString[c] = "?";				}			}			trace(" = " + codeString.join(" "));		}				public function call(...parameters) : *		{			var originalCode : Array = _code;			_code = _code.concat();			_args = parameters;			//trace("-----------");			for(var i : int = 0; i < _code.length; i++)			{				//traceLocals();				var current : *;				if(i+1 < _code.length)				{					current = _code[i+1];					if(current is String)					{						if(current == "(")						{							i+=2;							continue;						}						else if(current == ")" && i > 0)						{							_code.splice(i-1, 3, _code[i--]);							i-=2							continue;						}					}				}				current = _code[i];				if(current is Function)				{					_code.splice(i-1, 3, current(i--));					i-=2;				}				if(i >= _code.length && _code.length > 1)				{					i = -1;				}			}			var value : * = getVar(_code.length - 1);			_code = originalCode;			var string : String = value;			if(string && string.charAt(0) == '"' && string.charAt(string.length-1) == '"')			{				return string.slice(1, string.length-1).replace(/\\/g, "");			}			else if(_local && _args[0].hasOwnProperty(string))			{				return _args[0][string];			}			return value;		}		public static function eval(code : String, local : Boolean = false) : Function		{			return new SimpleEval(code, local).Call;		}		public function SimpleEval(code : String, local : Boolean = false)		{			_local = local;			_code = Compile(code);		}		private function compile(source : String) : Array		{			var arr : Array = source.split(/('([^\\']|(\\'?))*')|("([^\\"]|(\\"?))*")|([\+\-\*\/\(\)]|[<!>]?==?)|( )|([<>(&&)(\|\|)])/);			for(var i : int = 0; i < arr.length; i++)			{				switch(arr[i])				{					case "":					case " ":					case '"':					case "'":					case undefined:					case null:						arr.splice(i--, 1);						break;				}			}			for(i = 0; i < arr.length; i++)			{				if(!_local)				{					switch(arr[i])					{						case "x":						case "a":							arr[i] = "$0";							break;						case "y":						case "b":							arr[i] = "$1";							break;						case "z":						case "c":							arr[i] = "$2";							break;						case "w":						case "d":							arr[i] = "$3";							break;					}				}				switch(arr[i])				{					case "":					case " ":					case '"':					case "'":					case undefined:					case null:						arr.splice(i--, 1);						break;					case "<":					case "lt":						arr[i] = lessThan;						break;					case ">":					case "gt":						arr[i] = greaterThan;						break;					case "<=":					case "lt=":						arr[i] = lessThanOrEquals;						break;					case ">=":					case "gt=":						arr[i] = greaterThanOrEquals;						break;					case "==":						arr[i] = equals;						break;					case "!=":						arr[i] = notEquals;						break;					case "true":						arr[i] = true;						break;					case "false":						arr[i] = false;						break;					case "&":						if(i + 1 < arr.length && arr[i+1] == "&")							arr[i] = and;						arr.splice(i+1, 1);						break;					case "&&":						arr[i] = and;						break;					case "||":						arr[i] = or;						break;					case "+":						arr[i] = plus;						break;					case "-":						arr[i] = minus;						break;					case "*":						arr[i] = multiply;						break;					case "/":						arr[i] = divide;						break;					case "(":					case ")":					case ":":						break;					case "?":						arr[i] = ifElse;						break;					default:						var string : String = arr[i] + "";						var first : String = string.charAt(0);						var last : String = string.charAt(string.length-1);						if(string.length > 1 && (first == '"' && last == '"' || first == "'" && last == "'"))						{							arr[i] = '"' + string.slice(1, string.length-1) + '"';						}						else if(last == ",")						{							for(var c : int = i+1; c < arr.length; c++)							{								if(arr[c] == "-")								{									arr[i] += "-";								}								else if(/\d/.test(arr[c]))								{									arr[i] += arr[c];									arr.splice(i+1, c-i);									i--;									break;								}							}						}						else if(first == "!" && !_local)						{							switch(string.charAt(1))							{								case "x":								case "a":									arr[i] = "!$0" + string.slice(2);									break;								case "y":								case "b":									arr[i] = "!$1" + string.slice(2);									break;								case "z":								case "c":									arr[i] = "!$2" + string.slice(2);									break;								case "w":								case "d":									arr[i] = "!$3" + string.slice(2);									break;								case "$":									break;								default:									arr.splice(i--, 1);							}						}						else if(!isNaN(Number(arr[i])))						{							arr[i] = Number(arr[i]);						}						else if(/^[+-]?[0-9]*\.?[0-9]+,[+-]?[0-9]*\.?[0-9]+$/.test(arr[i]))						{							var notPoint : Boolean = true;							for(c = i-1; c > -1; c--)							{								if(arr[c] != undefined)								{									if(arr[c] == "(")									{										for(var j : int = i+1; j < arr.length; j++)										{											if(arr[j] != undefined)											{												if(arr[j] == ")")												{													var float : RegExp = /[+-]?[0-9]*\.?[0-9]+/g;													var number : String = float.exec(arr[i]);													var number1 : Number = (number.charAt(0) == "-" ? -1 : 1) * Number(/[^\+\-]+$/.exec(number));													number = float.exec(arr[i]);													var number2 : Number = (number.charAt(0) == "-" ? -1 : 1) * Number(/[^\+\-]+$/.exec(number));													arr[i] = new Point(number1, number2);													arr.splice(j, 1);													arr.splice(c, 1);													i--;													notPoint = false;													break;												}												else break;											}										}										break;									}									else break;								}							}							if(notPoint)							{								arr.splice(i--, 1);							}						}						else if(!_local && string.search(/^(\$\d+|[xyzwabcd])\.[a-zA-Z_][a-zA-Z0-9_-]*$/) > -1)						{							if(string.search(/^[xyzwabcd]/) > -1)							{								switch(first)								{									case "x":									case "a":										arr[i] = "$0" + string.slice(1);										break;									case "y":									case "b":										arr[i] = "$1" + string.slice(1)										break;									case "z":									case "c":										arr[i] = "$2" + string.slice(1)										break;									case "w":									case "d":										arr[i] = "$3" + string.slice(1)										break;								}							}						}						else if(!_local)						{							arr.splice(i--, 1);						}						break;				}			}			var functions : Vector.<Function> = Vector.<Function>([Divide, Multiply, Plus, Minus, LessThan, GreaterThan, LessThanOrEquals, GreaterThanOrEquals, Equals, NotEquals, And, Or]);			for(j = 0; j < functions.length; j++)			{				var f : Function = functions[j];				for(i = 0; i < arr.length; i++)				{					if(arr[i] == f)					{						i = addParenthesis(i, arr);					}				}			}			return arr;		}		private function addParenthesis(i : int, arr : Array) : int		{			var pCount : int = 0;			var index : int = i;			var foundValue : Boolean = false;			while(index-- > 0 && (pCount > 0 || !foundValue))			{				if(arr[index] == ")")				{					pCount++;				}				else if(arr[index] == "(")				{					pCount--;				}				else if(!(arr[index] is Function))				{					foundValue = true;				}			}			if(foundValue)			{				arr.splice(++index, 0, "(");				foundValue = false;				index = ++i;				while(++index < arr.length && (pCount > 0 || !foundValue))				{					if(arr[index] == "(")					{						pCount++;					}					else if(arr[index] == ")")					{						pCount--;					}					else if(!(arr[index] is Function))					{						foundValue = true;					}				}				if(foundValue)				{					arr.splice(index, 0, ")");				}			}			return i;		}		private function lessThan(i : int) : Boolean		{			return getVar(i-1) < getVar(i+1);		}		private function greaterThan(i : int) : Boolean		{			return getVar(i-1) > getVar(i+1);		}		private function lessThanOrEquals(i : int) : Boolean		{			return getVar(i-1) <= getVar(i+1);		}		private function greaterThanOrEquals(i : int) : Boolean		{			return getVar(i-1) >= getVar(i+1);		}		private function equals(i : int) : Boolean		{			var first : * = getVar(i-1);			var second : * = getVar(i+1);			if(first is Point && second is Point)			{				return first.equals(second);			}			return first == second;		}		private function notEquals(i : int) : Boolean		{			var first : * = getVar(i-1);			var second : * = getVar(i+1);			if(first is Point && second is Point)			{				return !first.equals(second);			}			return first != second;		}		private function and(i : int) : Boolean		{			return getVar(i-1) && getVar(i+1);		}		private function or(i : int) : Boolean		{			return getVar(i-1) || getVar(i+1);		}		private function plus(i : int) : *		{			var first : * = getVar(i-1, 0, false);			var second : * = getVar(i+1, 0, true);			if(first is Point && !(second is String))			{				return first.add(second);			}			return first + second;		}		private function minus(i : int) : *		{			var first : * = getVar(i-1);			if(first is Point)			{				return first.subtract(getVar(i+1));			}			return first - getVar(i+1);		}		private function multiply(i : int) : *		{			var first : * = getVar(i-1);			var second : * = getVar(i+1);			if(first is Point)			{				if(second is Point)				{					return first.x * second.x + first.y * second.y;				}				else				{					return new Point(first.x * second, first.y * second);				}			}			return first * second;		}		private function divide(i : int) : *		{			var first : * = getVar(i-1);			var second : * = getVar(i+1);			if(first is Point)			{				if(second is Point)				{					return Point.distance(first as Point, second as Point);				}				else				{					second = 1 / second;					return new Point(first.x * second, first.y * second);				}			}			return getVar(i-1) / getVar(i+1);		}		private function ifElse(i : int) : Object		{			var index1 : int = _code.indexOf(":", i);			if(getVar(i-1))			{				var pCount : int = 0;				var index2 : int = index1;				while(pCount > -1 && index2++ < _code.length)				{					if(_code[index2] == ")")					{						pCount--;					}					else if(_code[index2] == "(")					{						pCount++;					}				}				_code.splice(index1, index2 - index1);				return getVar(i+1);			}			else if(index1 + 1 < _code.length && i+2 < _code.length)			{				var variable : * = getVar(index1+1);				_code.splice(i+2, _code.indexOf(":", i+2)-i);				return variable;			}			return null;		}		private function getVar(i : int, count : int = 0, rightSide : Boolean = false) : *		{			if(_code[i] is Number || _code[i] is Boolean || _code[i] is Point)			{				return _code[i];			}			var varName : String = _code[i] as String;			if(varName && varName.length > 1)			{				var first : String = varName.charAt(0);				if(count > 0)				{					varName = varName.slice(count);				}				if(first == "!")				{					return !getVar(i, count + 1);				}				if(first == "$")				{					var object : * = _args[Number(varName.slice(1))];					var objectNames : Array = varName.split(".");					var c : int = 1;					while(c < objectNames.length)					{						object = object[objectNames[c++]];					}					if(object is String)					{						return rightSide ? object + '"' : '"' + object;					}					return object;				}				var last : String = varName.charAt(varName.length-1);				if(first == '"' && last == '"')				{					return rightSide ? varName.slice(1) : varName.slice(0, varName.length-1);				}				if(_local)				{					object = _args[0];					objectNames = varName.split(".");					c = 0;					while(c < objectNames.length)					{						if(object == null && c > 0)						{							trace("SimpleEval: Warning: null object reference.\n" + objectNames.join(".") + " at " + objectNames[i-1]);							return null;						}						object = object[objectNames[c++]];					}					return object;				}				return varName;			}			return null;		}	}}